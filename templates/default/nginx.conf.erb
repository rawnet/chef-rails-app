# WARNING: This file was generated by chef, any edits you make here will be nuked!
# Instead consider amending the chef recipe and re-deploying with Knife Solo

upstream <%= @app_name %>_<%= @environment %>_unicorn {
  server unix://<%= @environment_root %>/shared/sockets/unicorn.sock;
}

server  {

  <% unless @config['disable_http'] %>
  listen 80<%= ' default_server' if @config['default_vhost'] %>;
  <% end %>

  <% if @config['ssl'] %>
  listen 443 ssl<%= ' default_server' if @config['disable_http'] && @config['default_vhost'] %>;
  ssl_certificate <%= @config['ssl']['certificate_path'] %>;
  ssl_certificate_key <%= @config['ssl']['certificate_key_path'] %>;
  <% end %>

  server_name <%= @domains.join(' ') %>;

  root <%= @environment_root %>/current/public;

  <% if @config['force_www'] %>
  if ($host !~* ^www\.){
    rewrite ^(.*)$ $scheme://www.$host$1;
  }
  <% end %>

  <% if @config['client_max_body_size'] %>
  client_max_body_size <%= @config['client_max_body_size'] %>;
  <% end %>

  <% if @config['server_includes'] %>
    <% @config['server_includes'].each do |file| %>
      include <%= file %>;
    <% end %>
  <% end %>

  <% if @config['gzip'] %>
    gzip on;
    gzip_disable "msie6";

    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types <%= @config['gzip']['types'].join(' ') %>;
  <% end %>

  location / {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;

  <% if @load_balancer && @load_balancer["forward_scheme"] %>
    <% if @load_balancer["custom_ssl_header"] %>
    set $lb_scheme http;
    if ($http_<%= @load_balancer["custom_ssl_header"].downcase.gsub("-", "_") %> = "<%= @load_balancer["custom_ssl_value"]%>") {
      set $lb_scheme https;
    }
    proxy_set_header X-Forwarded-Proto $lb_scheme;
    <% else %>
    proxy_set_header X-Forwarded-Proto $scheme;
    <% end %>
  <% elsif @config['ssl'] %>
    proxy_set_header X-Forwarded-Proto $scheme;
  <% end %>

    proxy_redirect off;

    <% if @config["proxy_timeout"] %>
    proxy_connect_timeout  <%= @config["proxy_timeout"] %>;
    proxy_send_timeout  <%= @config["proxy_timeout"] %>;
    proxy_read_timeout  <%= @config["proxy_timeout"] %>;
    <% end %>

    <% if @http_basic_auth %>
      auth_basic "Restricted";
      auth_basic_user_file <%= @environment_root %>/shared/config/http_basic_auth.conf;
    <% end %>

    <% if @config["root_location_includes"] %>
      <% @config["root_location_includes"].each do |file| %>
        include <%= file %>;
      <% end %>
    <% end %>

    if (!-f $request_filename) {
      proxy_pass http://<%= @app_name %>_<%= @environment %>_unicorn;
      break;
    }
  }

  error_page 500 502 503 504 /500.html;
  location = /500.html {
    root <%= @environment_root %>/current/public;
  }
}

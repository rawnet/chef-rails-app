#!/bin/sh

# WARNING: This file was generated by chef, any edits you make here will be nuked!
# Instead consider amending the chef recipe and re-deploying with Knife Solo

set -e

USER=<%= @rails_user %>
RAILS_ENV=<%= @environment %>
APP_ROOT=<%= @environment_root %>/current
PID_PATH=<%= @environment_root %>/shared/log
PID=$PID_PATH/searchd.<%= @environment %>.pid

action="$1"
set -u

cd $APP_ROOT || exit 1

<% source_rbenv = "PATH=/home/#{@rails_user}/.rbenv/shims:/home/#{@rails_user}/.rbenv/bin:$PATH" %>

case "$1" in
  start)    
    echo "Starting Thinking Sphinx"
    su -l $USER -c 'cd <%= @environment_root %>/current && <%= source_rbenv %> RAILS_ENV=<%= @environment %> bundle exec rake thinking_sphinx:start'
    echo
    ;;
  stop)
    echo "Stopping Thinking Sphinx"
    su -l $USER -c 'cd <%= @environment_root %>/current && <%= source_rbenv %> RAILS_ENV=<%= @environment %> bundle exec rake thinking_sphinx:stop'
    echo
    ;;
  rebuild)
    echo "re-Building (Stop/Index/Start) Thinking Sphinx"
    su -l $USER -c 'cd <%= @environment_root %>/current && <%= source_rbenv %> RAILS_ENV=<%= @environment %> bundle exec rake thinking_sphinx:rebuild'
    echo
    ;;
  restart)
    echo "re-Starting Thinking Sphinx"
    su -l $USER -c 'cd <%= @environment_root %>/current && <%= source_rbenv %> RAILS_ENV=<%= @environment %> bundle exec rake thinking_sphinx:restart'
    echo
    ;;
  delayed_delta)
    echo "Process stored delta index requests"
    su -l $USER -c 'cd <%= @environment_root %>/current && <%= source_rbenv %> RAILS_ENV=<%= @environment %> bundle exec rake thinking_sphinx:delayed_delta'
    echo
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|rebuild|delayed_delta}"
    exit 1
esac
